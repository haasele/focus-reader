name: Flutter Multi-Platform CI (Stable)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: flutter-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_CHANNEL: stable
  JAVA_VERSION: '17'

jobs:
  android:
    name: Android
    runs-on: ubuntu-latest
    environment: ANDROID_KEYSIGN

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Install dependencies
        run: flutter pub get
        
      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.jks

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=release.jks" >> android/key.properties
          keytool -list -v \
            -keystore android/app/release.jks \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"

      - name: Build Android APK
        run: flutter build apk --release

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk


  web:
    name: Web
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Install dependencies
        run: flutter pub get
    
      - name: Build Web
        run: flutter build web --release

      - name: Upload Web
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web

  linux:
    name: Linux Desktop
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev fuse libfuse2 xorriso squashfs-tools \
            fakeroot dpkg-dev \
            ruby ruby-dev build-essential \
            wget file

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Extract version
        id: version
        run: |
          RAW=$(sed -n 's/^version:[[:space:]]*//p' pubspec.yaml | head -n 1)
          VERSION=${RAW%%+*}
          BUILD=${RAW##*+}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build=$BUILD" >> "$GITHUB_OUTPUT"

      - name: Build Linux
        run: flutter build linux --release

      - name: Install fpm for RPM packaging
        run: |
          sudo gem install fpm

      - name: Create DEB package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_NAME="focus-reader"
          BUILD_DIR="build/linux/x64/release/bundle"
          
          # Create DEB package structure
          mkdir -p deb-pkg/DEBIAN
          mkdir -p deb-pkg/usr/bin
          mkdir -p deb-pkg/usr/share/applications
          mkdir -p deb-pkg/usr/share/pixmaps
          mkdir -p deb-pkg/opt/$APP_NAME
          
          # Copy application files
          cp -r $BUILD_DIR/* deb-pkg/opt/$APP_NAME/
          
          # Create desktop entry
          echo "[Desktop Entry]" > deb-pkg/usr/share/applications/$APP_NAME.desktop
          echo "Version=1.0" >> deb-pkg/usr/share/applications/$APP_NAME.desktop
          echo "Type=Application" >> deb-pkg/usr/share/applications/$APP_NAME.desktop
          echo "Name=Focus Reader" >> deb-pkg/usr/share/applications/$APP_NAME.desktop
          echo "Comment=RSVP based eBook and PDF Reader" >> deb-pkg/usr/share/applications/$APP_NAME.desktop
          echo "Exec=/opt/$APP_NAME/focus_reader" >> deb-pkg/usr/share/applications/$APP_NAME.desktop
          echo "Icon=/opt/$APP_NAME/data/flutter_assets/assets/reader-icon.png" >> deb-pkg/usr/share/applications/$APP_NAME.desktop
          echo "Terminal=false" >> deb-pkg/usr/share/applications/$APP_NAME.desktop
          echo "Categories=Office;Viewer;" >> deb-pkg/usr/share/applications/$APP_NAME.desktop
          
          # Create symlink for easy access
          ln -s /opt/$APP_NAME/focus_reader deb-pkg/usr/bin/focus-reader
          
          # Create control file
          echo "Package: $APP_NAME" > deb-pkg/DEBIAN/control
          echo "Version: $VERSION" >> deb-pkg/DEBIAN/control
          echo "Architecture: amd64" >> deb-pkg/DEBIAN/control
          echo "Maintainer: Focus Reader Team" >> deb-pkg/DEBIAN/control
          echo "Description: Focus Reader - RSVP based eBook and PDF Reader" >> deb-pkg/DEBIAN/control
          echo " A modern eBook and PDF reader with RSVP (Rapid Serial Visual Presentation) functionality." >> deb-pkg/DEBIAN/control
          
          # Build DEB package
          dpkg-deb --build deb-pkg ${APP_NAME}_${VERSION}_amd64.deb

      - name: Create RPM package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_NAME="focus-reader"
          BUILD_DIR="build/linux/x64/release/bundle"
          
          # Create RPM using fpm
          fpm -s dir \
            -t rpm \
            -n $APP_NAME \
            -v $VERSION \
            -a x86_64 \
            --description "Focus Reader - RSVP based eBook and PDF Reader" \
            --prefix /opt/$APP_NAME \
            $BUILD_DIR

      - name: Create AppImage
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_NAME="FocusReader"
          BUILD_DIR="build/linux/x64/release/bundle"
          
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool.AppImage
          chmod +x appimagetool.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy application files to AppDir/usr/bin
          cp -r $BUILD_DIR/* AppDir/usr/bin/
          
          # Copy icon to multiple locations
          if [ -f "reader-icon.png" ]; then
            # Root level icon (required by AppImage)
            cp reader-icon.png AppDir/focus-reader.png
            # Icon in standard location
            cp reader-icon.png AppDir/usr/share/icons/hicolor/256x256/apps/focus-reader.png
            # Also create 128x128 and 64x64 for better compatibility
            mkdir -p AppDir/usr/share/icons/hicolor/128x128/apps
            mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps
            cp reader-icon.png AppDir/usr/share/icons/hicolor/128x128/apps/focus-reader.png
            cp reader-icon.png AppDir/usr/share/icons/hicolor/64x64/apps/focus-reader.png
          else
            echo "Warning: reader-icon.png not found, creating placeholder"
            # Create a simple placeholder if icon is missing
            convert -size 256x256 xc:transparent AppDir/focus-reader.png 2>/dev/null || \
            echo "Note: ImageMagick not available, skipping placeholder icon"
          fi
          
          # Create desktop entry at root level (REQUIRED by appimagetool)
          # The desktop file MUST be at AppDir root with name matching the icon
          echo "[Desktop Entry]" > AppDir/focus-reader.desktop
          echo "Version=1.0" >> AppDir/focus-reader.desktop
          echo "Type=Application" >> AppDir/focus-reader.desktop
          echo "Name=Focus Reader" >> AppDir/focus-reader.desktop
          echo "Comment=RSVP based eBook and PDF Reader" >> AppDir/focus-reader.desktop
          echo "Exec=usr/bin/focus_reader" >> AppDir/focus-reader.desktop
          echo "Icon=focus-reader" >> AppDir/focus-reader.desktop
          echo "Terminal=false" >> AppDir/focus-reader.desktop
          echo "Categories=Office;Viewer;" >> AppDir/focus-reader.desktop
          echo "StartupNotify=true" >> AppDir/focus-reader.desktop
          
          # Also create desktop entry in standard location
          cp AppDir/focus-reader.desktop AppDir/usr/share/applications/focus-reader.desktop
          
          # Create AppRun script
          echo '#!/bin/bash' > AppDir/AppRun
          echo 'HERE="$(dirname "$(readlink -f "${0}")")"' >> AppDir/AppRun
          echo 'exec "${HERE}/usr/bin/focus_reader" "$@"' >> AppDir/AppRun
          chmod +x AppDir/AppRun
          
          # Build AppImage
          ARCH=x86_64 ./appimagetool.AppImage AppDir ${APP_NAME}-${VERSION}-x86_64.AppImage

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            build/linux/x64/release/bundle
            focus-reader_*.deb
            focus-reader-*.rpm
            FocusReader-*.AppImage

  windows:
    name: Windows Desktop
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Extract version
        id: version
        run: |
          $raw = (Select-String -Path pubspec.yaml -Pattern '^version:' | Select-Object -First 1).Line
          $version = ($raw -replace 'version:\s*', '').Split('+')[0]
          $build = ($raw -replace 'version:\s*', '').Split('+')[1]
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "build=$build" >> $env:GITHUB_OUTPUT

      - name: Build Windows
        run: flutter build windows --release

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          # Refresh environment variables
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

      - name: Create MSI Installer
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $buildDir = "build\windows\x64\runner\Release"
          $appName = "FocusReader"
          
          # Find WiX Toolset installation path
          # Search in common installation locations
          $possiblePaths = @()
          
          # Check Program Files (x86) and Program Files
          foreach ($pf in @("${env:ProgramFiles(x86)}", $env:ProgramFiles)) {
            if ($pf) {
              $wixDirs = Get-ChildItem "$pf" -Filter "WiX Toolset*" -Directory -ErrorAction SilentlyContinue
              foreach ($dir in $wixDirs) {
                $binPath = Join-Path $dir.FullName "bin"
                if (Test-Path (Join-Path $binPath "heat.exe")) {
                  $possiblePaths += $binPath
                }
              }
            }
          }
          
          # Also check if it's in PATH
          try {
            $heatCmd = Get-Command heat.exe -ErrorAction Stop
            $possiblePaths += Split-Path $heatCmd.Source
          } catch {
            # Not in PATH, continue searching
          }
          
          if ($possiblePaths.Count -eq 0) {
            throw "WiX Toolset not found. Searched in Program Files and PATH."
          }
          
          $wixPath = $possiblePaths[0]
          Write-Host "Using WiX Toolset from: $wixPath"
          
          # Add WiX to PATH for this session
          $env:PATH = "$wixPath;$env:PATH"
          
          # Use heat.exe to harvest all files from the build directory
          & heat.exe dir "$buildDir" -out files.wxs -gg -g1 -sfrag -srd -scom -sreg -dr INSTALLFOLDER -cg ApplicationFiles -var var.SourceDir
          
          # Create main installer file
          $wxsLines = @(
            "<?xml version='1.0' encoding='utf-8'?>",
            "<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>",
            "  <?include files.wxs ?>",
            "  <Product Id='*' Name='$appName' Language='1033' Version='$version' Manufacturer='Focus Reader' UpgradeCode='{B8B8B8B8-B8B8-B8B8-B8B8-B8B8B8B8B8B8}'>",
            "    <Package InstallerVersion='200' Compressed='yes' InstallScope='perMachine' />",
            "    <MajorUpgrade DowngradeErrorMessage='A newer version of [ProductName] is already installed.' />",
            "    <MediaTemplate />",
            "    <Feature Id='ProductFeature' Title='$appName' Level='1'>",
            "      <ComponentGroupRef Id='ApplicationFiles' />",
            "      <ComponentRef Id='ApplicationShortcut' />",
            "    </Feature>",
            "    <Directory Id='TARGETDIR' Name='SourceDir'>",
            "      <Directory Id='ProgramFilesFolder'>",
            "        <Directory Id='INSTALLFOLDER' Name='$appName' />",
            "      </Directory>",
            "      <Directory Id='ProgramMenuFolder'>",
            "        <Directory Id='ApplicationProgramsFolder' Name='$appName' />",
            "      </Directory>",
            "    </Directory>",
            "    <SetDirectory Id='INSTALLFOLDER' Value='[ProgramFilesFolder]$appName' />",
            "    <Component Id='ApplicationShortcut' Directory='ApplicationProgramsFolder' Guid='{A2A2A2A2-A2A2-A2A2-A2A2-A2A2A2A2A2A2}'>",
            "      <Shortcut Id='ApplicationStartMenuShortcut' Name='$appName' Description='Focus Reader - RSVP based eBook and PDF Reader' Target='[INSTALLFOLDER]runner.exe' WorkingDirectory='INSTALLFOLDER' />",
            "      <RemoveFolder Id='ApplicationProgramsFolder' On='uninstall' />",
            "      <RegistryValue Root='HKCU' Key='Software\$appName' Type='string' Value='' KeyPath='yes' />",
            "    </Component>",
            "  </Product>",
            "</Wix>"
          )
          $wxsLines | Out-File -FilePath installer.wxs -Encoding UTF8
          
          # Replace SourceDir variable in files.wxs
          (Get-Content files.wxs) -replace 'Source="SourceDir', "Source=`"$buildDir" | Set-Content files.wxs
          
          # Compile and link
          & candle.exe installer.wxs files.wxs -dSourceDir="$buildDir"
          & light.exe installer.wixobj files.wixobj -o "$appName-$version.msi" -ext WixUIExtension

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            build/windows/x64/runner/Release
            FocusReader-*.msi

  macos:
    name: macOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Extract version
        id: version
        run: |
          RAW=$(sed -n 's/^version:[[:space:]]*//p' pubspec.yaml | head -n 1)
          VERSION=${RAW%%+*}
          BUILD=${RAW##*+}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build=$BUILD" >> "$GITHUB_OUTPUT"

      - name: Build macOS
        run: flutter build macos --release

      - name: Create PKG Installer
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_NAME="Focus Reader"
          BUNDLE_ID="com.example.focusReader"
          APP_PATH="build/macos/Build/Products/Release/focus_reader.app"
          PKG_NAME="FocusReader-${VERSION}.pkg"
          
          # Create a temporary directory for the package
          mkdir -p pkg-root/Applications
          cp -R "$APP_PATH" pkg-root/Applications/
          
          # Create component plist file
          echo '<?xml version="1.0" encoding="UTF-8"?>' > component.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> component.plist
          echo '<plist version="1.0">' >> component.plist
          echo '<array>' >> component.plist
          echo '  <dict>' >> component.plist
          echo '    <key>BundleHasStrictIdentifier</key>' >> component.plist
          echo '    <true/>' >> component.plist
          echo '    <key>RootRelativeBundlePath</key>' >> component.plist
          echo '    <string>Applications/focus_reader.app</string>' >> component.plist
          echo '  </dict>' >> component.plist
          echo '</array>' >> component.plist
          echo '</plist>' >> component.plist
          
          # Create the package
          pkgbuild \
            --root pkg-root \
            --identifier "$BUNDLE_ID" \
            --version "$VERSION" \
            --install-location "/" \
            --component-plist component.plist \
            "$PKG_NAME"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            build/macos/Build/Products/Release
            FocusReader-*.pkg


