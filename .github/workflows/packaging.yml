name: Artifact Packaging

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - Flutter Multi-Platform CI (Stable)
    types:
      - completed


permissions:
  contents: write

jobs:
  prepare:
    name: Prepare Release
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=$(sed -n 's/^version:[[:space:]]*//p' pubspec.yaml | head -n 1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
  windows:
    needs: prepare
    runs-on: windows-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: windows

      - name: Create ZIP
        run: |
          Compress-Archive windows FocusReader-windows.zip

      - name: Build MSI (WiX)
        run: |
          choco install wixtoolset -y
          candle installer.wxs
          light installer.wixobj -o FocusReader.msi

      - uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            FocusReader-windows.zip
            FocusReader.msi
  macos:
    needs: prepare
    runs-on: macos-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: macos

      - name: Create ZIP
        run: |
          ditto -c -k macos FocusReader-macos.zip

      - name: Build PKG
        run: |
          pkgbuild \
            --root macos \
            --identifier com.example.focusreader \
            --version ${{ needs.prepare.outputs.version }} \
            FocusReader.pkg

      - uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            FocusReader-macos.zip
            FocusReader.pkg
  linux:
    needs: prepare
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: linux

      - name: Create ZIP
        run: |
          zip -r FocusReader-linux.zip linux

      - name: Build DEB
        run: |
          sudo apt install -y fakeroot dpkg-dev rpm
          mkdir -p pkg/DEBIAN
          echo "Package: focus-reader
          Version: ${{ needs.prepare.outputs.version }}
          Architecture: amd64
          Maintainer: You
          Description: Focus Reader" > pkg/DEBIAN/control
          cp -r linux pkg/usr/local/focus-reader
          dpkg-deb --build pkg FocusReader.deb

      - name: Build RPM
        run: |
          fpm -s dir -t rpm linux=/opt/focus-reader -n focus-reader -v ${{ needs.prepare.outputs.version }}

      - name: Build AppImage
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage linux FocusReader.AppImage

      - uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            FocusReader-linux.zip
            FocusReader.deb
            *.rpm
            FocusReader.AppImage
